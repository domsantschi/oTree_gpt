{{ block title }}
    {{ category_name }} - Budget Forecast (Round {{ round_number }}/{{ total_rounds }})
{{ endblock }}

{{ block content }}

<p><strong>Role:</strong> {{ role }}</p>

<div class="alert alert-info">
    <strong>Scenario:</strong> It is the end of the fiscal year. You are tasked with forecasting the {{ category_name }} expenses for the upcoming year (Year Y). Below you will find historical data from the past 10 years (Y-10 to Y-1) to inform your estimate.
</div>

<!-- Historical Data -->
<div class="card mb-4">
    <div class="card-header">
        <strong>Historical Data - {{ category_name }} (Years Y-10 to Y-1)</strong>
    </div>
    <div class="card-body">
        <p class="text-muted">{{ trend_description }}</p>
        <div class="row">
            <div class="col-md-6">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th>Budgeted</th>
                            <th>Actual</th>
                            <th>Diff</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
            <div class="col-md-6">
                <canvas id="historicalChart" height="250"></canvas>
            </div>
        </div>
        
        <!-- Comprehension Check -->
        <div class="mt-3 p-3 bg-light rounded">
            <label class="form-label"><strong>Comprehension Check:</strong> What were the actual expenses in the most recent year (Y-1)? (in CHF thousands)</label>
            <input type="number" name="comprehension_check" id="comprehension_check" class="form-control" style="max-width: 200px;" placeholder="Enter value" required>
        </div>
    </div>
</div>

<!-- Step 1: Best Estimate -->
<div class="card mb-4">
    <div class="card-header">
        <strong>Step 1: Best Estimate for Year Y</strong>
    </div>
    <div class="card-body">
        <p>What is your best estimate for the upcoming year's (Year Y) {{ category_name }} expenses?</p>
        <div class="mb-3">
            <label class="form-label">Estimate (CHF {{ slider_min }}-{{ slider_max }},000)</label>
            <input type="range" class="form-range" id="forecastSlider"
                   min="{{ slider_min }}" max="{{ slider_max }}" value="{{ last_year_actual }}" step="1">
            <div class="text-center"><strong id="forecastValue">CHF {{ last_year_actual }},000</strong></div>
            <input type="hidden" name="initial_forecast" id="initial_forecast" value="{{ last_year_actual }}">
        </div>
    </div>
</div>

<!-- Step 2: Buffer -->
<div class="card mb-4">
    <div class="card-header">
        <strong>Step 2: Buffer for Uncertainty</strong>
    </div>
    <div class="card-body">
        <p>How much buffer to add for uncertainty?</p>
        <div class="mb-3">
            <label class="form-label">Buffer (0-100%)</label>
            <input type="range" class="form-range" id="adjustmentSlider" min="0" max="100" value="0" step="1">
            <div class="text-center">
                <span id="adjustmentValue">0%</span> | 
                <strong id="finalBudgetValue">Total: CHF {{ last_year_actual }},000</strong>
            </div>
            <input type="hidden" name="budget_adjustment" id="budget_adjustment" value="0">
        </div>
    </div>
</div>

<!-- Step 3: Justification -->
<div class="card mb-4">
    <div class="card-header">
        <strong>Step 3: Justification</strong>
    </div>
    <div class="card-body">
        {{ formfield 'initial_justification' }}
    </div>
</div>

<div class="text-center mt-4">
    {{ next_button }}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const budgetData = {{ historical_budget|safe }};
    const actualData = {{ historical_actual|safe }};
    const yearLabels = ['Y-10', 'Y-9', 'Y-8', 'Y-7', 'Y-6', 'Y-5', 'Y-4', 'Y-3', 'Y-2', 'Y-1'];

    // Populate table
    const tableBody = document.getElementById('historyTableBody');
    for (let i = 0; i < budgetData.length; i++) {
        const row = document.createElement('tr');
        const diff = actualData[i] - budgetData[i];
        const diffSign = diff >= 0 ? '+' : '';
        row.innerHTML = '<td>' + yearLabels[i] + '</td><td>' + budgetData[i] + '</td><td>' + actualData[i] + '</td><td>' + diffSign + diff + '</td>';
        tableBody.appendChild(row);
    }

    // Chart
    const ctx = document.getElementById('historicalChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: yearLabels,
            datasets: [
                { label: 'Budgeted', data: budgetData, borderColor: 'rgb(220, 53, 69)', fill: false },
                { label: 'Actual', data: actualData, borderColor: 'rgb(13, 110, 253)', fill: false }
            ]
        },
        options: { responsive: true, scales: { y: { beginAtZero: false } } }
    });

    // Sliders
    const forecastSlider = document.getElementById('forecastSlider');
    const forecastValue = document.getElementById('forecastValue');
    const forecastHidden = document.getElementById('initial_forecast');
    const adjustmentSlider = document.getElementById('adjustmentSlider');
    const adjustmentValue = document.getElementById('adjustmentValue');
    const adjustmentHidden = document.getElementById('budget_adjustment');
    const finalBudgetValue = document.getElementById('finalBudgetValue');

    function update() {
        const f = parseInt(forecastSlider.value);
        const p = parseInt(adjustmentSlider.value);
        const a = Math.round(f * p / 100);
        forecastValue.textContent = 'CHF ' + f + ',000';
        forecastHidden.value = f;
        adjustmentValue.textContent = p + '%';
        adjustmentHidden.value = a;
        finalBudgetValue.textContent = 'Total: CHF ' + (f + a) + ',000';
    }

    forecastSlider.addEventListener('input', update);
    adjustmentSlider.addEventListener('input', update);
</script>

{{ endblock }}
