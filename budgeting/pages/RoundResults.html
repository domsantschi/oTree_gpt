{% extends "global/Page.html" %}
{% load otree %}

{% block title %}
    <div style="display: none;">Round {{ round_number }} Complete</div>
{% endblock %}

{% block styles %}
<style>
    /* Hide oTree's built-in timer */
    .otree-timer {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Timer Banner -->
<div class="alert alert-warning sticky-top" style="z-index: 1000; text-align: center;">
    <strong>Time left:</strong> <span id="globalTimer" style="font-weight: bold;">{{ time_remaining }}</span>
</div>

<div class="text-center mt-4">
    <h4>Round {{ round_number }} Complete!</h4>
    <p><strong>{{ account_title }} ({{ account_type }})</strong></p>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">This Round</h5>
            </div>
            <div class="card-body">
                <p><strong>Civil Servant's Forecast:</strong> CHF {{ forecast_formatted }}</p>
                <p><strong>Agreed Amount:</strong> CHF {{ agreed_formatted }}</p>
                <hr>
                <p><strong>Deviation from Forecast:</strong> 
                    {% if round_deviation == 0 %}
                        <span class="text-success">CHF 0 - Exactly on target!</span>
                    {% else %}
                        <span class="text-warning">CHF {{ round_deviation_formatted }}</span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Cumulative Performance</h5>
            </div>
            <div class="card-body">
                <p><strong>Rounds Completed:</strong> {{ rounds_completed }}</p>
                <p><strong>Total Deviation from Forecasts:</strong> CHF {{ total_deviation_formatted }}</p>
                <p><strong>Average Deviation per Round:</strong> CHF {{ avg_deviation_formatted }}</p>
            </div>
        </div>
    </div>
</div>

<div class="alert alert-success mt-4">
    <p class="mb-2"><strong>Ready for the Next Round?</strong> Click "Next" below to continue with the next budget account.</p>
    <p class="mb-0 text-muted"><small><i class="fas fa-info-circle"></i> Remember: The more rounds you complete, the higher your compensation!</small></p>
</div>

<div class="text-center mt-5">
    {{ next_button }}
</div>

<script>
    // Timer countdown
    var timeLeft = parseInt('{{ time_remaining_seconds }}') || 0;
    var globalTimerElement = document.getElementById('globalTimer');

    function formatTimeRemaining(seconds) {
        if (seconds < 0) seconds = 0;
        var minutes = Math.floor(seconds / 60);
        var secs = seconds % 60;
        if (minutes > 0) {
            return minutes + ' min ' + String(secs).padStart(2, '0') + ' sec';
        }
        return secs + ' sec';
    }

    if (globalTimerElement) {
        globalTimerElement.textContent = formatTimeRemaining(timeLeft);
    }

    // Update global timer
    var timerInterval = setInterval(function() {
        if (timeLeft > 0) {
            timeLeft--;
        }
        
        if (globalTimerElement) {
            globalTimerElement.textContent = formatTimeRemaining(timeLeft);
        }

        if (timeLeft <= 0) {
            clearInterval(timerInterval);
        }
    }, 1000);
</script>

{% endblock %}