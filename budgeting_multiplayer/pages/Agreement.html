{{ block title }}
    Compare Proposals
{{ endblock }}

{{ block styles }}
<style>
    /* Hide oTree's built-in timer */
    .otree-timer {
        display: none !important;
    }
</style>
{{ endblock }}

{{ block content }}
<!-- Timer Banner -->
<div class="alert alert-warning sticky-top" style="z-index: 1000; text-align: center;">
    <strong>Time left:</strong> <span id="globalTimer" style="font-weight: bold;">{{ time_remaining }}</span>
</div>

<div class="text-center mt-4 mb-4" style="display: none;">
    <h3>Compare Proposals: {{ account_title }} {{ formatted_account_type }} Budget</h3>
</div>

<!-- Civil Servant's Forecast Reference -->
<div class="alert alert-success text-center mb-4">
    <strong>Specialized Civil Servant's Forecast:</strong> CHF {{ forecast }},000
</div>

<!-- Proposals Comparison -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">{{ your_role }}'s Proposal (You)</h5>
            </div>
            <div class="card-body text-center">
                <h2>CHF {{ your_proposal }},000</h2>
                <small class="text-muted">
                    {% if your_deviation == 0 %}
                        Matches forecast
                    {% elif your_deviation > 0 %}
                        +CHF {{ your_deviation }},000 above forecast
                    {% else %}
                        CHF {{ your_deviation }},000 below forecast
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">{{ partner_role }}'s Proposal</h5>
            </div>
            <div class="card-body text-center">
                <h2>CHF {{ partner_proposal }},000</h2>
                <small class="text-muted">
                    {% if partner_deviation == 0 %}
                        Matches forecast
                    {% elif partner_deviation > 0 %}
                        +CHF {{ partner_deviation }},000 above forecast
                    {% else %}
                        CHF {{ partner_deviation }},000 below forecast
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Agreement Decision -->
<div class="card">
    <div class="card-header text-white" style="background-color: #6f42c1;">
        <h5 class="mb-0">Your Decision</h5>
    </div>
    <div class="card-body">
        <p class="mb-3"><strong>The lower budget proposal is CHF {{ lower_budget }},000</strong></p>
        
        <div class="mb-4">
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="agreed" id="agree_yes" value="True" required>
                <label class="form-check-label" for="agree_yes">
                    <strong>Yes</strong> - I agree with the lower budget of CHF {{ lower_budget }},000
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="agreed" id="agree_no" value="False">
                <label class="form-check-label" for="agree_no">
                    <strong>No</strong> - I want to resubmit my budget proposal
                </label>
            </div>
        </div>

        <div id="alternate_budget_section" style="display: none;">
            <div class="mb-3">
                <label class="form-label"><strong>Adjust your proposal using the slider:</strong></label>
                
                <div class="d-flex align-items-center mb-2">
                    <span class="me-2">CHF {{ slider_min }},000</span>
                    <input type="range" 
                           class="form-range flex-grow-1 mx-2" 
                           id="alternateSlider"
                           min="{{ slider_min }}" 
                           max="{{ slider_max }}"
                           value="{{ forecast }}"
                           step="1">
                    <span class="ms-2">CHF {{ slider_max }},000</span>
                </div>
                
                <div class="text-center">
                    <h4 id="alternateSliderValue" class="text-primary">CHF {{ forecast }},000</h4>
                </div>
                
                <input type="hidden" name="alternate_amount" id="alternate_amount" value="0">
            </div>
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg">Submit Decision</button>
        </div>
    </div>
</div>

<script>
    // Get elements
    var agreeYes = document.getElementById('agree_yes');
    var agreeNo = document.getElementById('agree_no');
    var alternateBudgetSection = document.getElementById('alternate_budget_section');
    var alternateAmountInput = document.getElementById('alternate_amount');
    var alternateSlider = document.getElementById('alternateSlider');
    var alternateSliderValue = document.getElementById('alternateSliderValue');
    var forecast = {{ forecast }};

    // Handle Yes choice - hide alternate section
    agreeYes.addEventListener('change', function() {
        if (this.checked) {
            alternateBudgetSection.style.display = 'none';
            alternateAmountInput.value = '0';
        }
    });

    // Handle No choice - show alternate section
    agreeNo.addEventListener('change', function() {
        if (this.checked) {
            alternateBudgetSection.style.display = 'block';
            alternateSlider.value = forecast;
            alternateSliderValue.textContent = 'CHF ' + forecast.toLocaleString() + ',000';
            alternateAmountInput.value = forecast;
        }
    });
    
    // Slider functionality
    alternateSlider.addEventListener('input', function() {
        var value = parseInt(this.value);
        alternateSliderValue.textContent = 'CHF ' + value.toLocaleString() + ',000';
        alternateAmountInput.value = value;
    });

    // Global timer countdown
    var timeLeft = parseInt('{{ time_remaining_seconds }}') || 0;
    var globalTimerElement = document.getElementById('globalTimer');

    function formatTimeRemaining(seconds) {
        if (seconds < 0) seconds = 0;
        var minutes = Math.floor(seconds / 60);
        var secs = seconds % 60;
        if (minutes > 0) {
            return minutes + ' min ' + String(secs).padStart(2, '0') + ' sec';
        }
        return secs + ' sec';
    }

    if (globalTimerElement) {
        globalTimerElement.textContent = formatTimeRemaining(timeLeft);
    }

    var countdown = setInterval(function() {
        if (timeLeft > 0) {
            timeLeft--;
        }
        
        if (globalTimerElement) {
            globalTimerElement.textContent = formatTimeRemaining(timeLeft);
        }

        if (timeLeft <= 0) {
            clearInterval(countdown);
            // Auto-submit with Yes selected
            agreeYes.checked = true;
            alternateAmountInput.value = '0';
            document.querySelector('form').submit();
        }
    }, 1000);
</script>

{{ endblock }}
