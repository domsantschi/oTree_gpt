{{ block title }}
    <!-- Round {{ round_number }}: {{ account_title }} {{ formatted_account_type }} Budget -->
{{ endblock }}

{{ block styles }}
<style>
    /* Hide oTree's built-in timer */
    .otree-timer {
        display: none !important;
    }
</style>
{{ endblock }}

{{ block content }}
<!-- Timer Banner -->
<div class="alert alert-warning sticky-top" style="z-index: 1000; text-align: center;">
    <strong>Time left:</strong> <span id="globalTimer" style="font-weight: bold;">{{ time_remaining }}</span>
</div>

<!-- Round Title -->
<div class="text-center mt-4 mb-4">
    <h3>Round {{ round_number }}: {{ account_title }} {{ formatted_account_type }} Budget</h3>
    <p class="text-muted">Your Role: <strong>{{ role }}</strong></p>
</div>

<!-- Forecast from Specialized Civil Servant -->
<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="fas fa-user-tie"></i> Specialized Civil Servant's Forecast</h5>
    </div>
    <div class="card-body text-center">
        <p class="mb-2">Based on detailed analysis, the specialized civil servant recommends:</p>
        <h2 class="text-success">CHF {{ forecast }},000</h2>
        <p class="text-muted mb-0">This is the best estimate for the {{ account_title }} {{ formatted_account_type }} budget.</p>
    </div>
</div>

<!-- Historical Data Section -->
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0">Historical Data (Last 5 Years)</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Table View -->
            <div class="col-md-6">
                <h6 class="mb-3">Historical Amounts</h6>
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Year</th>
                            <th>Amount (CHF)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Year -4</td>
                            <td>{{ historical_formatted.0 }}</td>
                        </tr>
                        <tr>
                            <td>Year -3</td>
                            <td>{{ historical_formatted.1 }}</td>
                        </tr>
                        <tr>
                            <td>Year -2</td>
                            <td>{{ historical_formatted.2 }}</td>
                        </tr>
                        <tr>
                            <td>Year -1</td>
                            <td>{{ historical_formatted.3 }}</td>
                        </tr>
                        <tr class="table-info">
                            <td><strong>Current</strong></td>
                            <td><strong>{{ historical_formatted.4 }}</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Chart View -->
            <div class="col-md-6">
                <h6 class="mb-3">Trend Visualization</h6>
                <canvas id="historicalChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Budget Proposal Section with Slider -->
<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Your Budget Proposal</h5>
    </div>
    <div class="card-body">
        <p class="mb-3">Adjust the slider to set your proposed budget. You can increase or decrease from the civil servant's forecast.</p>
        
        <div class="form-group">
            <label for="proposalSlider" class="form-label"><strong>Your Proposed Amount:</strong></label>
            
            <div class="d-flex align-items-center mb-3">
                <span class="me-2">CHF {{ slider_min }},000</span>
                <input type="range" 
                       class="form-range flex-grow-1 mx-2" 
                       id="proposalSlider"
                       min="{{ slider_min }}" 
                       max="{{ slider_max }}"
                       value="{{ forecast }}"
                       step="1">
                <span class="ms-2">CHF {{ slider_max }},000</span>
            </div>
            
            <div class="text-center">
                <h3 id="sliderValue" class="text-primary">CHF {{ forecast }},000</h3>
                <p id="deviationDisplay" class="text-muted">Deviation from forecast: CHF 0</p>
            </div>
            
            <!-- Hidden input for form submission -->
            <input type="hidden" name="proposed_amount" id="proposed_amount" value="{{ forecast }}">
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg">Submit Proposal</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Historical data chart
    const ctx = document.getElementById('historicalChart').getContext('2d');
    const historicalData = {{ historical_data|safe }};
    const forecast = {{ forecast }};

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Year -4', 'Year -3', 'Year -2', 'Year -1', 'Current'],
            datasets: [{
                label: '{{ account_title }} (CHF thousands)',
                data: historicalData,
                borderColor: 'rgb(23, 162, 184)',
                backgroundColor: 'rgba(23, 162, 184, 0.1)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'CHF (thousands)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                annotation: {
                    annotations: {
                        forecastLine: {
                            type: 'line',
                            yMin: forecast,
                            yMax: forecast,
                            borderColor: 'rgb(40, 167, 69)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                content: 'Forecast',
                                enabled: true
                            }
                        }
                    }
                }
            }
        }
    });

    // Slider functionality
    const slider = document.getElementById('proposalSlider');
    const sliderValueDisplay = document.getElementById('sliderValue');
    const deviationDisplay = document.getElementById('deviationDisplay');
    const hiddenInput = document.getElementById('proposed_amount');

    slider.addEventListener('input', function() {
        const value = parseInt(this.value);
        sliderValueDisplay.textContent = `CHF ${value.toLocaleString()},000`;
        hiddenInput.value = value;
        
        const deviation = value - forecast;
        const absDeviation = Math.abs(deviation);
        if (deviation > 0) {
            deviationDisplay.textContent = `Deviation from forecast: +CHF ${absDeviation.toLocaleString()},000 (above)`;
            deviationDisplay.className = 'text-warning';
        } else if (deviation < 0) {
            deviationDisplay.textContent = `Deviation from forecast: -CHF ${absDeviation.toLocaleString()},000 (below)`;
            deviationDisplay.className = 'text-warning';
        } else {
            deviationDisplay.textContent = `Deviation from forecast: CHF 0 (matches forecast)`;
            deviationDisplay.className = 'text-success';
        }
    });

    // Global timer countdown with auto-submit
    let timeLeft = parseInt({{ time_remaining_seconds }}) || 0;
    const globalTimerElement = document.getElementById('globalTimer');
    const form = document.querySelector('form');

    function formatTimeRemaining(seconds) {
        if (seconds < 0) seconds = 0;
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        if (minutes > 0) {
            return `${minutes} min ${String(secs).padStart(2, '0')} sec`;
        }
        return `${secs} sec`;
    }

    if (globalTimerElement) {
        globalTimerElement.textContent = formatTimeRemaining(timeLeft);
    }

    const countdown = setInterval(() => {
        if (timeLeft > 0) {
            timeLeft--;
        }
        
        if (globalTimerElement) {
            globalTimerElement.textContent = formatTimeRemaining(timeLeft);
        }

        if (timeLeft <= 0) {
            clearInterval(countdown);
            // Auto-submit the form when time expires
            if (form) {
                form.submit();
            }
        }
    }, 1000);
</script>
{{ endblock }}